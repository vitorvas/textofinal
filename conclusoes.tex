% ----------------------------------------------------------
% Conclusões
% ----------------------------------------------------------
\chapter{Conclusões}
\label{chap:conclusoes}

Nesta tese foi desenvolvido um sistema livre, aberto e gratuito para
cálculos neutrônicos e termo-hidráulicos de forma acoplada utilizando
malhas idênticas. Além do sistema propriamente dito, foi também desenvolvida
uma metodologia para a construção deste sistema acoplado baseada em sistemas
já existentes livres e utilizando memória compartilhada como forma de
intercâmbio de dados.

Este sistema é inovador ao utilizar o \textit{framework OpenFOAM}, baseado
em volumes finitos, como ferramenta de cálculos termo-hidráulicos e o
código de cálculos de física de reatores aberto \textit{milonga} como ferramenta
para cálculos neutrônicos. A utilização de memória compartilhada como
espaço de intercâmbio de dados, apesar de conhecida \cite{Maciel2011, Theler2013},
é praticamente ignorada pela comunidade de engenharia nuclear computacional na
implementação de sistemas acoplados. Tal situação é de se estranhar, já que o
uso de memória compartilhada permite a comunicação entre os sistemas acoplados
de forma confiável, robusta e tão rápida quanto qualquer acesso à memória
do computador. O sistema desenvolvido nesta tese faz uso de memória compartilhada,
sendo o único sistema conhecido de cálculos acoplados baseados em volumes finitos. 

O sistema desenvolvido, por acoplar dois sistemas de cálculos que utilizam
a formulação de volumes finitos para solução de sistemas de equações diferenciais,
explora a característica de domínio idêntico para os dois sistemas. Em outras palavras,
os domínios de solução, ou malhas, são os mesmos para ambos o que evita a utilização
de funções de mapeamento, ou seja, evita o \textit{overhead} do mapeamento geométrico,
um problema de geometria computacional não-trivial no caso de malhas não-estruturadas.

Há, naturalmente, vantagens e desvantagens no uso de malha idêntica. Uma desvantagem
é o custo computacional para malhas refinadas. Além disso, o fluxo neutrônico geralmente
não precisa ser conhecido em detalhes na maioria dos cálculos de núcleo de reatores,
o que fundamenta eventuais críticas ao custo computacional do sistema desenvolvido. 
Entretanto, o objetivo dos cálculos por volumes
finitos é permitir identificar pequenas ocorrências imperceptíveis
em cálculos por métodos menos granulares. O sistema desenvolvido nesta tese, cuja
prova conceitual foi feita com uma malha relativamente pobre, permite conhecer fenômenos
locais calculados a partir de elementos da multi-física envolvida, e não apenas
de perfis de potência genéricos ou temperaturas médias, por exemplo. 

O desenvolvimento desta tese levou também a contribuições fora do seu escopo principal.
Incidentalmente, ao acessar o código-fonte dos sistemas utilizados para permitir seu
uso acoplado, foram encontradas
falhas de implementação em ambos os sistemas utilizados para neutrônica e termo-hidráulica.
Os erros encontrados no \textit{OpenFOAM} foram reportados para a comunidade.
Os erros encontrados no \textit{milonga} não só foram reportados ao seu autor como,
em um caso crítico, foi feita a correção diretamente e então enviado o \textit{patch} ao autor.
Essa correção foi incorporada numa versão posterior do \textit{milonga}.
Estas contribuições incidentais se dão devido à própria natureza do desenvolvimento baseado
em \textit{software} livre, que prevê e se baseia em contribuições e trocas entre a comunidade
de usuários, desenvolvedores e autores.

É dessa corrente de desenvolvimento que surge outra e talvez a principal característica inovadora
do sistema desenvolvido nesta tese: ele é construído exclusivamente a partir
de sistemas abertos e livres\footnote{A metodologia utilizada
  na geração de seções de choque utiliza um \textit{software} restrito. Entretanto, a geração
  de seções de choque, apesar de fundamental para os cálculos neutrônicos, não é, propriamente dita,
  parte do sistema acoplado, já que qualquer ferramenta pode ser utilizada para este propósito. Neste tema, começam também a surgir opções em \textit{software} livre
  para a geração de seções de choque em multi-grupos a partir de bibliotecas contínuas \cite{Slaybaugh2014}.}.
Esta característica e suas implicações merecem uma seção exclusiva.


\section{Discussão sobre \textit{software} livre}

A princípio, o fato de um \textit{software} ser distribuído de forma livre ou restrita pode soar indiferente.
Entretanto, numa avaliação mais cuidadosa, é fácil
perceber que a liberdade na utilização, modificação e distribuição de um \textit{software} trás imediatamente
diversos benefícios ao seu usuário. O primeiro
benefício é financeiro. Não é necessário dispender dinheiro em licenças de uso, autorizações de uso ou
qualquer outro aspecto do uso de \textit{software}. Essa independência financeira na relação com o \textit{software} é, em último caso,
ainda mais importante para países em desenvolvimento que, nem sempre, conseguem garantir um fluxo constante
no aporte de financiamento a instituições de pesquisa e acadêmicas. O Brasil entra, obviamente, nesta lista.

A liberdade de utilização está intimamente ligada ao acesso ao código-fonte, que, como anteriormente apresentado,
é obrigatoriamente distribuído com a versão binária ou executável do \textit{software} no caso de sistemas
livres. A capacidade de estudar, entender, modificar e experimentar
com o \textit{software} está totalmente ligada ao acesso a como se dá seu funcionamento. É novamente fácil perceber que,
do ponto de vista tecnológico, o acesso ao código-fonte funciona como uma transferência de tecnologia. Além disso, no
aspecto educacional, é uma forma de colocar as novas e futuras gerações de profissionais em contato com a tecnologia na
prática, para além das abordagens didáticas e teóricas, por vezes limitadas a casos canônicos ou simplificações. 


%\begin{figure}[htb]
%  \caption{Conclusões: o sistema acoplado.}
%  \centering\includegraphics[scale=0.7]{figuras/conclusoes1.png}
%  \label{metodoetapas}
%  \legend{Fonte: autor}
%\end{figure}

Complementando os aspectos financeiro e de liberdade de utilização, há ainda, no tocante ao \textit{software} livre,
o aspecto de distribuição do conhecimento. Se não explicitamente, já que um código sem comentários e sem manual oferece
pouca oportunidade de aprendizado se tomarmos o pior caso, um código medianamente comentado e com um manual de utilização mesmo
simples oferece uma oportunidade para se conhecer novas técnicas de desenvolvimento, linguagens, padrões de desenvolvimento, ferramentas,
métodos e algoritmos. E esta lista é não-exaustiva. Além disso, baseado nas contribuições comunitárias, a lista de possibilidades
de aprendizado cresce de acordo com o número de contribuintes e a intensidade com que contribuem. Deve-se ainda mencionar
a autoverificação. Um código aberto é amplamente auditável e, quanto mais usuários o leem, maior a possibilidade de se
encontrar falhas ou, em alguns casos, código malicioso. Talvez seja este aspecto, o alicerce que sustenta a forma de desenvolvimento
livre. E aparentemente, essa forma de desenvolvimento, ainda que de forma tardia, começa a atingir a indústria nuclear
\cite{Romano2013, Boyd2014, Theler2014b, Huff2016}.


Cabe, antes de finalizar esta seção, uma observação. Não se pretende nesta breve discussão advogar em favor do \textit{software}
livre como a solução mágica para todos os problemas do conhecimento humano. Há uma infinidade de situações em que pode ser desejável
que detalhes de implementação ou que o código-fonte seja preservado, por exemplo. A razão pode ser financeira, estratégica ou de segurança.
O que se pretende, não sem certa ousadia, é trazer à luz a discussão do uso de \textit{software} livre na e pela indústria nuclear. Há sólidos
argumentos favoráveis e contrários à sua utilização. O que não se pode é ignorar sua existência e abrir mão de investigar e discutir como
esta filosofia, se se pode utilizar esta palavra, de desenvolvimento de sistemas de computação pode vir a contribuir no desenvolvimento
da Engenharia Nuclear.

\section{Trabalhos Futuros}

Em um trabalho de prova de conceito, a discussão sobre perspectivas futuras ganha uma importância adicional.
O sistema desenvolvido nesta tese possui diversas limitações, apresentadas na seção \ref{subsec:lim}. Uma vez
provado o conceito, o próximo passo consiste em estender o alcance do sistema a casos mais complexos. Para
isso devem ser superadas as limitações técnicas apresentadas. Além disso, sendo o sistema acoplado nada
mais do que ambos os sistemas utilizados modificados internamente, eventuais melhorias no sistema acoplado
passam, obrigatoriamente, por evolução, modificações ou expansão nos sistemas utilizados. Sendo assim, nesta seção são apresentadas formas
de superar as limitações já apresentadas bem como opções adicionais com o objetivo de ampliar a utilização
do sistema acoplado atual. 

Hoje, tanto o \textit{OpenFOAM} quanto o \textit{milonga} são distribuídos exclusivamente para o sistema
operacional Linux \cite{LinuxBritannica}. Para fazer com que sejam utilizados em outras plataformas, são necessárias
modificações em seus códigos-fonte e em seus sistemas de compilação e instalação. O \textit{OpenFOAM}, dada sua
ampla rede de usuários, já possui iniciativas neste sentido. O \textit{milonga}, entretanto, possui apenas pequenas partes
adaptadas à compilação multiplataforma. De forma a expandir o alcance de ambos, é necessário fazer com que ambos
sejam passíveis de compilação multiplataforma. Há disponíveis ferramentas com esse intuito \cite{Martin2008}. Com ambos os
sistemas disponíveis em multiplataforma, as modificações no sistema acoplado seriam pequenas e factíveis.

Um trabalho futuro que traria enormes impactos na capacidade de atacar grandes problemas em relação malhas refinadas
com muitos elementos é a implementação de uma versão paralela do \textit{milonga}. A implementação em paralelo dos
cálculos em volumes finitos e de cálculo das matrizes do problema de autovalores permitira uma escalabilidade
fundamental para os cálculos neutrônicos. Na versão atual, todo o processo é feito sequencialmente: toda a malha
é percorrida, todas as interpolações célula a célula feitas, então é construída a matriz de solução e então resolvido
o sistema na matriz. A execução em paralelo permite dividir o domínio em cada núcleo\footnote{A arquitetura dos processadores
  atuais implementa unidades de processamento independentes, denominadas \textit{core}. Isso significa que a
capacidade de multiprocessamento é inerente a esses processadores.} e resolver paralelamente
uma escala menor do problema. Isso se aplica tanto ao problema de construção das matrizes a partir dos volumes finitos
quanto à solução da matriz propriamente dita. Algoritmos de solução de matrizes de vários tipos, amplamente conhecidos
e utilizados, estão disponíveis sendo, alguns dos mais robustos deles \cite{Hernandez2005, Balay2016}, distribuídos livremente.
Neste caso, seriam necessárias adaptações no sistema acoplado dependendo da forma de divisão do domínio. Estas adaptações teriam
um certo grau de complexidade. Entretanto, a implementação do sistema acoplado já foi feita com vistas à execução em paralelo,
de modo que laços e elementos de programação paralela estão implementados para distintos núcleos utilizando MPI \cite{Quinn2004}.

De carona na implementação em paralelo, outra candidata para melhorias é a função de percurso de células atualmente
implementada no \textit{milonga}. Levantamentos preliminares mostraram que a atual implementação do \textit{milonga}
gasta grande parte do tempo de execução nesta função, devido à interpolação de temperaturas por célula. A otimização
desta função levaria a ganhos no tempo total de execução. A otimização desta função não está diretamente ligada à
implementação em paralelo. Entretanto, antes da paralelização de qualquer algoritmo, é usual que
se trabalhe na sua versão ótima (ou tão boa quanto possível).

A aplicação utilizada para a prova de conceito se restringiu à utilização da aproximação por difusão para os cálculos
de fluxo de nêutrons. O \textit{milonga} oferece ainda a opção de utilização do método de ordenadas discretas,
também chamado de método $S_N$ \cite{Hebert2009}, para a solução da equação de transporte. Entretanto, para problemas
maiores a demanda por memória do método citado inviabiliza seu uso. A reimplementação deste método com objetivo de
otimizar o uso de memória pode ser um caminho para a solução mais precisa do fluxo de nêutrons se comparado ao método
de aproximação por difusão. Além disso, está em curso a implementação do método de características \cite{Hebert2009} no \textit{milonga}
por membros da comunidade argentina de Física de Reatores.

A expansão do \textit{solver OpenFOAM} para o cálculo de transientes além de estado estacionário, também é possível.
Para isso, uma abordagem é adaptar um novo \textit{solver OpenFOAM} já existente capaz de lidar com variações em relação
ao tempo utilizando os arquivos e modificações já feitas no sistema atual. Este seria um trabalho mais elaborado.

Outra linha de trabalho consiste em alterar a utilização de malhas em ambos os códigos, otimizando o uso de memória
compartilhada. Neste caso, as classes utilizadas no \textit{OpenFOAM} na implementação da utilização de malhas podem
ser estendidas - servindo-se do conceito de herança, existente no paradigma de programação orientada a objetos e
do qual o \textit{OpenFOAM} se baseia - para que o armazenamento de toda a estrutura de dados se dê em memória compartilhada.
Isso exigiria ainda que toda a implementação do \textit{milonga} no tratamento de malhas, fosse também modificada de acordo.
Esta abordagem já consiste num grande trabalho de projeto e implementação de software. A consequência deste trabalho seria
a utilização de uma única macroestrutura de dados para representação do domínio em memória, utilizando, a grosso modo,
metade da memória utilizada na implementação atual. Essa nova implementação poderia, ainda, ser projetada para
funcionar em paralelo.

Ainda no tocante à implementação dos sistemas envolvidos, há a possibilidade de utilizar a capacidade ociosa de placas
gráficas para, por exemplo, a solução das matrizes de autovalores. Esta abordagem, entretanto, necessita de mais estudos
sobre sua viabilidade.

Fora dos trabalhos futuros relativos à implementações de novas funcionalidades, estão simulações numéricas mais elaboradas
utilizando-se o sistema atual. É fato que, com as limitações atuais, em especial relativas ao cálculo sequencial, não é
possível utilizar o sistema para problemas elaborados. Porém, estudos de validação utilizando problemas conhecidos
(\textit{benchmarks}) são fundamentais para que o sistema desenvolvido possa ser, eventualmente, considerado para
simulações em nível de licenciamento ou aplicações de missão crítica.

Os possíveis caminhos de desenvolvimento futuro e aplicações não estão limitados aos apresentados neste capítulo.
A expectativa ao fim deste trabalho de tese é continuar contribuindo para o desenvolvimento do ecossistema de
ferramentas computacionais com foco nas vantagens do desenvolvimento baseado em \textit{software} livre para todos
os envolvidos e interessados em computação científica aplicada à engenharia nuclear.


